---
# tasks/mariadb.yml — Démarrage et configuration de MariaDB

- name: Initialiser MariaDB (RedHat/Rocky)
  ansible.builtin.command: mysql_install_db --user=mysql --datadir=/var/lib/mysql
  args:
    creates: /var/lib/mysql/mysql
  when: ansible_os_family == "RedHat"

- name: Démarrer MariaDB en arrière-plan (conteneur sans systemd)
  ansible.builtin.shell: |
    pgrep mysqld || mysqld_safe --datadir=/var/lib/mysql &
  changed_when: false

- name: Attendre le démarrage de MariaDB
  ansible.builtin.pause:
    seconds: 10

- name: Sécuriser MariaDB — Changer le mot de passe root
  ansible.builtin.command: >
    mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED BY '{{ wp_db_root_password }}';"
  changed_when: false
  failed_when: false

- name: Sécuriser MariaDB — Supprimer les utilisateurs anonymes
  ansible.builtin.command: >
    mysql -uroot -p{{ wp_db_root_password }} -e "DELETE FROM mysql.user WHERE User='';"
  changed_when: false
  failed_when: false

- name: Sécuriser MariaDB — Supprimer la base test
  ansible.builtin.command: >
    mysql -uroot -p{{ wp_db_root_password }} -e "DROP DATABASE IF EXISTS test;"
  changed_when: false
  failed_when: false

- name: Sécuriser MariaDB — Nettoyer les permissions test
  ansible.builtin.command: >
    mysql -uroot -p{{ wp_db_root_password }} -e "DELETE FROM mysql.db WHERE Db='test' OR Db='test\\_%';"
  changed_when: false
  failed_when: false

- name: Appliquer les privilèges
  ansible.builtin.command: >
    mysql -uroot -p{{ wp_db_root_password }} -e "FLUSH PRIVILEGES;"
  changed_when: false

- name: Créer la base de données WordPress
  ansible.builtin.command: >
    mysql -uroot -p{{ wp_db_root_password }} -e "CREATE DATABASE IF NOT EXISTS {{ wp_db_name }};"
  changed_when: false

- name: Créer l'utilisateur WordPress
  ansible.builtin.command: >
    mysql -uroot -p{{ wp_db_root_password }} -e "CREATE USER IF NOT EXISTS '{{ wp_db_user }}'@'localhost' IDENTIFIED BY '{{ wp_db_password }}';"
  changed_when: false

- name: Accorder les privilèges à l'utilisateur WordPress
  ansible.builtin.command: >
    mysql -uroot -p{{ wp_db_root_password }} -e "GRANT ALL PRIVILEGES ON {{ wp_db_name }}.* TO '{{ wp_db_user }}'@'localhost'; FLUSH PRIVILEGES;"
  changed_when: false
